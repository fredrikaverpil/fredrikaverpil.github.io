{{- $sandbox := .Get "sandbox" -}}
{{- $engine := "browser" -}}
{{- $outputMode := .Get "output-mode" | default "" -}}

{{- /* Set scratch variables to trigger script loading */ -}}
{{- .Page.Scratch.Set "codapi" true -}}
{{- if in (slice "lua" "php" "python" "ruby" "sqlite") $sandbox -}}
  {{- $engine = "wasi" -}}
  {{- .Page.Scratch.Set "codapi_wasi" true -}}
{{- end -}}

{{- /* Apply syntax highlighting */ -}}
{{- $highlighted := transform.Highlight .Inner $sandbox "" -}}

<div class="code-block-wrapper">
  <button class="copy-code-button" aria-label="Copy code to clipboard">
    <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
    </svg>
    <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
  </button>
  {{- $highlighted | safeHTML -}}
  {{- if ne $outputMode "" -}}
  <codapi-snippet engine="{{ $engine }}" sandbox="{{ $sandbox }}" editor="basic" output-mode="{{ $outputMode }}"></codapi-snippet>
  {{- else -}}
  <codapi-snippet engine="{{ $engine }}" sandbox="{{ $sandbox }}" editor="basic"></codapi-snippet>
  {{- end -}}
</div>
