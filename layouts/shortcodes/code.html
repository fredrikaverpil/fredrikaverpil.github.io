{{- /* Include a source file with syntax highlighting */ -}}
{{- $file := .Get "file" -}}
{{- $lang := .Get "lang" -}}
{{- $rootDir := .Page.File.Dir -}}

{{- /* Construct the full path - relative to the blog post directory */ -}}
{{- $filePath := printf "%s%s" $rootDir $file -}}

{{- /* Auto-detect language from file extension if not specified */ -}}
{{- $lang = $lang | default (path.Ext $file | strings.TrimPrefix ".") -}}

{{- /* Map "go" to "golang" to avoid Chroma misdetecting as GDScript */ -}}
{{- $lang = cond (eq $lang "go") "golang" $lang -}}

{{- /* Read the file */ -}}
{{- $content := readFile (printf "content/%s" $filePath) -}}

{{- if not $content -}}
  <div class="error">Error: Could not load file {{ $filePath }}</div>
{{- else -}}
  {{- /* Highlight the code */ -}}
  {{- $highlighted := transform.Highlight $content $lang "" -}}

  <div class="code-block-wrapper">
    <button class="copy-code-button" aria-label="Copy code to clipboard">
      <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
      </svg>
      <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </button>
    {{- $highlighted | safeHTML -}}
  </div>
{{- end -}}
