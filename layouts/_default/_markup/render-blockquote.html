{{- $content := .Text -}}
{{- $type := "" -}}
{{- $title := "" -}}
{{- $fold := "" -}}
{{- $isCollapsible := false -}}

{{- if eq .Type "alert" -}}
  {{- $type = .AlertType -}}
  {{- $title = .AlertTitle -}}
{{- else -}}
  {{- /* Legacy/Custom Callout parsing (Regex) with optional Fold support (+/-) */ -}}
  {{- $match := findRE `\[!([a-zA-Z]+)([-+]?)\]\s*` .Text 1 -}} 
  {{- if gt (len $match) 0 -}}
    {{- $matchStr := index $match 0 -}}
    
    {{- /* Clean up the match string to extract type and suffix */ -}}
    {{- $clean := replace (replace $matchStr "[!" "") "]" "" -}}
    {{- $clean = trim $clean " " -}}
    
    {{- /* Check for suffix */ -}}
    {{- $suffix := substr $clean -1 -}}
    {{- if or (eq $suffix "+") (eq $suffix "-") -}}
      {{- $type = substr $clean 0 -1 -}}
      {{- $isCollapsible = true -}}
      {{- if eq $suffix "+" -}}
        {{- $fold = "open" -}}
      {{- else -}}
        {{- $fold = "closed" -}}
      {{- end -}}
    {{- else -}}
      {{- $type = $clean -}}
    {{- end -}}
    
    {{- $type = lower $type -}}
    {{- $title = $type | humanize -}}
    
    {{- /* Remove the [!TYPE] tag from the content. */ -}}
    {{- $content = replace .Text $matchStr "" -}}
  {{- end -}}
{{- end -}}

{{- /* Icon Mapping (Material Design) */ -}}
{{- $iconPath := "" -}}
{{- if eq $type "note" -}}
  {{- $iconPath = "M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z" -}}
{{- else if eq $type "tip" -}}
  {{- $iconPath = "M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" -}}
{{- else if eq $type "warning" -}}
  {{- $iconPath = "M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" -}}
{{- else if eq $type "important" -}}
  {{- $iconPath = "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" -}}
{{- else if eq $type "caution" -}}
  {{- $iconPath = "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" -}}
{{- else if eq $type "example" -}}
  {{- $iconPath = "M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" -}}
{{- else if eq $type "quote" -}}
  {{- $iconPath = "M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z" -}}
{{- else -}}
  {{- /* Default Icon (Info) */ -}}
  {{- $iconPath = "M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z" -}}
{{- end -}}

{{- if $isCollapsible -}}
<details class="callout markdown-alert {{ with $type }}callout-{{ . }} markdown-alert-{{ . }}{{ end }}" {{ if eq $fold "open" }}open{{ end }}>
  <summary class="callout-title markdown-alert-title">
    <div style="display: flex; align-items: center; gap: 0.5em;">
      <svg class="callout-icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" fill="currentColor"><path d="{{ $iconPath }}"></path></svg>
      {{ $title }}
    </div>
  </summary>
  <div class="callout-content">{{ $content | safeHTML }}</div>
</details>
{{- else -}}
<blockquote class="callout markdown-alert {{ with $type }}callout-{{ . }} markdown-alert-{{ . }}{{ end }}">
  {{- if $type -}}
  <div class="callout-title markdown-alert-title">
    <svg class="callout-icon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" fill="currentColor"><path d="{{ $iconPath }}"></path></svg>
    {{ $title }}
  </div>
  {{- end -}}
  <div class="callout-content">{{ $content | safeHTML }}</div>
</blockquote>
{{- end -}}
